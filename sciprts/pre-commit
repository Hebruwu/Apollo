#!/usr/bin/env bash

# This script is to be placed under .git/hooks/pre-commit when setting up.

set -euo pipefail

echo "üîç Running pre-commit checks..."

# Only check staged Go files
GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)
MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(md|markdown)$' || true)
DOCKERFILES=$(git diff --cached --name-only --diff-filter=ACM | grep -i 'dockerfile' || true)

# -------------------------
# Go formatting
# -------------------------
if [[ -n "$GO_FILES" ]]; then
  echo "üßπ Formatting Go files..."
  gofmt -w $GO_FILES
  goimports -w $GO_FILES
  git add $GO_FILES

  echo "üîç Running go vet..."
  go vet ./...
fi

# -------------------------
# Go linting
# -------------------------
if [[ -n "$GO_FILES" ]]; then
  echo "üîç Running golangci-lint..."
  golangci-lint run
fi

# -------------------------
# Dockerfile checks
# -------------------------
if [[ -n "$DOCKERFILES" ]]; then
  echo "üê≥ Linting Dockerfiles..."
  for file in $DOCKERFILES; do
    hadolint "$file"
  done
fi

# -------------------------
# Markdown checks
# -------------------------
if [[ -n "$MD_FILES" ]]; then
  echo "üìù Linting Markdown..."
  markdownlint --fix $MD_FILES
  git add $MD_FILES
fi

echo "‚úÖ Pre-commit checks passed!"
